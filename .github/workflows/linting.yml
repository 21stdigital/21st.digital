name: Lint code style issues

on:
  pull_request:
  workflow_call:
  workflow_dispatch:

jobs:
  changes:
    name: Detect changes in relevant files
    runs-on: ubuntu-latest

    outputs:
      php: ${{ steps.filter.outputs.php }}
      ts: ${{ steps.filter.outputs.ts }}
      css: ${{ steps.filter.outputs.css }}
      changed: ${{ steps.filter.outputs.changed }}

      php_files: ${{ steps.filter.outputs.php_files }}
      ts_files: ${{ steps.filter.outputs.ts_files }}
      css_files: ${{ steps.filter.outputs.css_files }}
      changed_files: ${{ steps.filter.outputs.changed_files }}

    steps:
      - name: Filter changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            php:
              - added|modified: '*.php'
            ts:
              - added|modified: '**/*.ts'
            css:
              - added|modified: '**/*.css'
            changed:
              - added|modified: '**/*'
          list-files: shell

  linting:
    name: Lint Code Styling
    needs: changes
    if: ${{ needs.changes.outputs.php == 'true' || needs.changes.outputs.ts == 'true' || needs.changes.outputs.css == 'true' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.11.0

      - name: Install Dependencies
        run: npm ci --prefer-offline

      - name: Run Prettier
        run: npm run prettier:check ${{ needs.changes.outputs.changed_files }}

      - name: Lint PHP
        if: ${{ needs.changes.outputs.php == 'true' }}
        uses: aglipanci/laravel-pint-action@v2
        with:
          testMode: true
          verboseMode: true

      - name: Lint Typescript
        if: ${{ needs.changes.outputs.ts == 'true' }}
        run: npm run lint:js ${{ needs.changes.outputs.ts_files }}

      - name: Lint CSS
        if: ${{ needs.changes.outputs.css == 'true' }}
        run: npm run lint:css ${{ needs.changes.outputs.css_files }}
